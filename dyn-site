#!/bin/bash

cmd=$1
shift
script="../guest-tools/bin/.action.sh"
guest_script="/home/ubuntu/tools/bin/.action.sh"

RootSrv=/home/ubuntu/RodaSrv 

if [ -f "$script" ]; then
    echo "## do not modify since automatically generated" > $script
fi

case $cmd in
new)
    ## répertoires à créer
    mkdir -p bin
    mkdir -p DockerFiles
    ## 
    rodaport=9700
    rodauid=1000
    rodagid=1000
    rodatools=$HOME/Share/Roda
    rodamongouser=mongo
    rodamongopwd=lol2mongo
    rodamongoport=27018
    dyndocubuntu=disco
    rversion="4.0.2"
    osidentifier="ubuntu-204"
    ## user root to mount volumes
    user_root=$HOME/Share/DockerSite
    rodapublic=RodaPublic
    rodadyndoclibrary=dyndoc-library
    rodadyndocworld=dyndoc-world
    rodamongodir=dyndoc-mongo
    while true 
    do
        cmd=$1
        shift
        case $cmd in
        --port)
            rodaport=$1
            shift
        ;;
        --uid)
            rodauid=$1
            shift
        ;;
        --gid)
            rodagid=$1
            shift
        ;;
        -r|--user-root)
            user_root=$1
            shift
        ;;
        -p|--public)
            rodapublic=$1
            shift
        ;;
        -t|--tools)
            rodatools=$1
            shift
        ;;
        -u|--ubuntu)
            dyndocubuntu=$1
            shift
        ;;
        --os)
            osidentifier=$1
            shift
        ;;
        --rversion)
            rversion=$1
            shift
        ;;
        -l|--libs)
            rodadyndoclibrary=$1
            shift
        ;;
        -w|--world)
            rodadyndocworld=$1
            shift
        ;;
        --mongo-user)
            rodamongouser=$1
            shift
        ;;
        --mongo-pwd)
            rodamongopwd=$1
            shift
        ;;
        --mongo-port)
            rodamongoport=$1
            shift
        ;;
        --mongo-dir)
            rodamongodir=$1
            shift
        ;;
        *)
            break
        ;;
        esac
        cmd=$1
    done
    rodapublic="${user_root}/${rodapublic}"
    rodadyndoclibrary="${user_root}/${rodadyndoclibrary}"
    rodadyndocworld="${user_root}/${rodadyndocworld}"
    rodamongodir="${user_root}/${rodamongodir}"
    ## RodaSrvPublic folder volume to mount
    mkdir -p $rodapublic
    mkdir -p $rodadyndoclibrary
    mkdir -p $rodadyndocworld
    mkdir -p $rodamongodir/data/db
    mkdir -p $rodamongodir/data/configdb
    mkdir -p ../guest-tools/bin
    cp scripts/guest-install.sh ../guest-tools/bin/.install.sh

    # creating docker-compose.yml
    txt=`cat template/docker-compose.yml`
    txt=${txt//RodaSrvPort/$rodaport}
    txt=${txt//RodaSrvUID/$rodauid}
    txt=${txt//RodaSrvGID/$rodagid}
    txt=${txt//RodaSrvPublic/$rodapublic}
    txt=${txt//RodaSrvTools/$rodatools}
    txt=${txt//DyndocRubyUbuntu/$dyndocubuntu}
    txt=${txt//RodaSrvDyndocLibrary/$rodadyndoclibrary}
    txt=${txt//RodaSrvDyndocWorld/$rodadyndocworld}
    txt=${txt//RodaSrvMongoUser/$rodamongouser}
    txt=${txt//RodaSrvMongoPwd/$rodamongopwd}
    txt=${txt//RodaSrvMongoPort/$rodamongoport}
    txt=${txt//RodaSrvMongoDir/$rodamongodir}
    echo "$txt" > "docker-compose.yml"
    
    # creating DockerFile-dyndoc
    txt=`cat template/Dockerfile-dyndoc`
    txt=${txt//RodaSrvPort/$rodaport}
    txt=${txt//RodaSrvUID/$rodauid}
    txt=${txt//RodaSrvGID/$rodagid}
    txt=${txt//RodaSrvPublic/$rodapublic}
    txt=${txt//RodaSrvTools/$rodatools}
    txt=${txt//DyndocRubyUbuntu/$dyndocubuntu}
    txt=${txt//DyndocRubyRVERSION/$rversion}
    txt=${txt//DyndocRubyOSIDENTIFIER/$osidentifier}
    txt=${txt//RodaSrvDyndocLibrary/$rodadyndoclibrary}
    txt=${txt//RodaSrvDyndocWorld/$rodadyndocworld}
    echo "$txt" > "DockerFiles/Dockerfile-dyndoc"
    
    # creating DockerFile-website
    txt=`cat template/Dockerfile-website`
    txt=${txt//RodaSrvPort/$rodaport}
    txt=${txt//RodaSrvUID/$rodauid}
    txt=${txt//RodaSrvGID/$rodagid}
    txt=${txt//RodaSrvPublic/$rodapublic}
    txt=${txt//RodaSrvTools/$rodatools}
    txt=${txt//DyndocRubyUbuntu/$dyndocubuntu}
    txt=${txt//RodaSrvDyndocLibrary/$rodadyndoclibrary}
    txt=${txt//RodaSrvDyndocWorld/$rodadyndocworld}
    echo "$txt" > "DockerFiles/Dockerfile-website"
    ;;
init)
    ## Create the RodaSrv folders inside container
    echo "mkdir -p /home/ubuntu/RodaSrv/edit" >  $script
    echo "mkdir -p /home/ubuntu/RodaSrv/public" >>  $script
    echo "cd /home/ubuntu/RodaSrv"  >>  $script
    echo "ln -sf .tools/system system" >>  $script
    echo "cd public"  >>  $script
    echo "ln -sf ../.tools/tools tools" >>  $script
    ## Config file
    echo "echo '---' > /home/ubuntu/dyndoc/etc/dyn-html.yml" >> $script
    echo "echo 'root: /home/ubuntu/RodaSrv' >> /home/ubuntu/dyndoc/etc/dyn-html.yml" >> $script
    docker-compose exec --user ubuntu website bash ${guest_script}
    ;;
add)
    # get RodaWebUser from environment variable
    RodaWebUser=$1
    if [ "$RodaWebUser" != "" ]; then
        echo "mkdir -p ${RootSrv}/public/pages" >>  $script
        echo "mkdir -p ${RootSrv}/public/users/${RodaWebUser}/{.pages,.edit}" >>  $script
        echo "cd ${RootSrv}/public/pages" >>  $script
        echo "ln -sf ../users/${RodaWebUser}/.pages ${RodaWebUser}" >>  $script
        echo "cd ${RootSrv}/edit" >>  $script
        echo "ln -sf ../public/users/${RodaWebUser}/.edit ${RodaWebUser}" >>  $script
        docker-compose exec --user ubuntu website bash ${guest_script}
    fi
    if [ "$2" == "--with-rodasrv-dir" ]; then
        mkdir -p ~/RodaSrv/edit
        RodapublicPath=$(readlink -f "`pwd`/../RodaPublic")
        cd ~/RodaSrv
        ln -s ${RodapublicPath} public
        cd edit
        ln -s "${RodapublicPath}/users/${RodaWebUser}/.edit" ${RodaWebUser}
    fi
    ;;
status | start | stop)
    docker-compose exec --user ubuntu website bash -c "/usr/local/bin/dyn-ctl $cmd"
    ;;
bash)
    user=ubuntu
    if [ "$1" = "--user-root" ];then
        user=root
    fi
    docker-compose exec --user $user website bash
    ;;
build)
    docker-compose build dyndoc-ruby
    docker-compose build website
    ;;
up)
    docker-compose up -d website
    ;;
down)
    docker-compose down
    ;;
pause)
    docker-compose pause
    ;;
unpause)
    docker-compose unpause
    ;;
*-user)
    echo ". /home/ubuntu/tools/bin/.install.sh" >> $script
    echo "${cmd} $*" >> $script
    docker-compose exec --user ubuntu website bash ${guest_script}
    ;;
*-root)
    echo ". /home/ubuntu/tools/bin/.install.sh" >> $script
    echo "${cmd} $*" >> $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
*-host)
    . scripts/host-install.sh
    ${cmd} $*
    ;;
gem)
    echo "gem $*" > $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
rb-pkg)
    echo "gem install $*" > $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
R-pkg)
    echo "R -e \"install.packages('${1}',repos='http://cran.rstudio.com/')\"" > $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
jl-pkg)
    echo "julia -e 'import Pkg;Pkg.add(\"${1}\")'" > $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
dpm | dyn-pkg | pkg)
    user=$1
    pkg=$2
    link=$3
    if [ "${link}" = "" ]; then
        link="${user}/${pkg}"
    else
        link="${user}/${pkg}/${link}"
    fi
     
	echo "dpm install ${user}/${pkg}" > $script
	echo "dpm link ${link}" >> $script
    docker-compose exec --user root website bash ${guest_script}
    ;;
mongo-up)
    docker-compose up -d mongo
    ;;
mongo-down)
    docker-compose down mongo
    ;;
mongo)
    docker-compose $* mongo
    ;;
mongo-express-up)
    docker-compose up -d mongo-express
    ;;
mongo-express-down)
    docker-compose down mongo-express
    ;;
mongo-express)
    docker-compose $* mongo-express
    ;;
esac